name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run security audit weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Stage 1: Install & Cache Dependencies
  # ============================================
  install:
    name: Install Dependencies
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

  # ============================================
  # Stage 2: Parallel Quality Checks
  # ============================================
  changeset:
    name: Changeset Check
    if: github.event_name == 'pull_request'
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch base ref
        run: git fetch origin ${{ github.base_ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for changeset
        run: pnpm changeset status --since=origin/${{ github.base_ref }}

  lint:
    name: Lint
    if: github.event_name != 'schedule'
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

  typecheck:
    name: Type Check
    if: github.event_name != 'schedule'
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages (required for type resolution)
        run: pnpm build

      - name: Type check
        run: pnpm typecheck

  format:
    name: Format Check
    if: github.event_name != 'schedule'
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Format check
        run: pnpm format:check

  security:
    name: Security Audit
    if: github.event_name != 'schedule'
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Security audit
        run: pnpm audit --audit-level=high

  # ============================================
  # Stage 3: Build & Test
  # ============================================
  build:
    name: Build
    if: github.event_name != 'schedule'
    needs: [lint, typecheck, format]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Verify build artifacts exist
        run: |
          # Verify core package outputs exist
          test -f packages/policy-engine/dist/index.js || (echo "policy-engine build missing" && exit 1)
          test -f packages/mcp-server/dist/index.js || (echo "mcp-server build missing" && exit 1)
          test -f packages/ucp-types/dist/index.js || (echo "ucp-types build missing" && exit 1)
          test -f packages/insights/dist/index.js || (echo "insights build missing" && exit 1)
          echo "✓ All build artifacts verified"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-output
          path: packages/*/dist
          retention-days: 1

  test:
    name: Test
    if: github.event_name != 'schedule'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Test with coverage
        run: pnpm test:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        with:
          files: ./packages/policy-engine/coverage/lcov.info,./packages/mcp-server/coverage/lcov.info,./packages/insights/coverage/lcov.info
          fail_ci_if_error: false

  # ============================================
  # Stage 4: Integration Validation
  # ============================================
  integration:
    name: Integration Check
    if: github.event_name != 'schedule'
    needs: [build, test, security]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Verify MCP server loads
        run: |
          # Verify the MCP server module can be imported without errors
          node -e "import('./packages/mcp-server/dist/index.js').then(() => console.log('✓ MCP server module loaded successfully')).catch(e => { console.error('✗ MCP server failed to load:', e.message); process.exit(1); })"

      - name: Verify package exports
        run: |
          node -e "import('./packages/policy-engine/dist/index.js').then(m => console.log('✓ policy-engine exports:', Object.keys(m).join(', '))).catch(e => { console.error('✗ policy-engine failed:', e.message); process.exit(1); })"
          node -e "import('./packages/ucp-types/dist/index.js').then(m => console.log('✓ ucp-types exports:', Object.keys(m).join(', '))).catch(e => { console.error('✗ ucp-types failed:', e.message); process.exit(1); })"
          node -e "import('./packages/insights/dist/index.js').then(m => console.log('✓ insights exports:', Object.keys(m).join(', '))).catch(e => { console.error('✗ insights failed:', e.message); process.exit(1); })"

  # ============================================
  # Weekly: Dependency Health Report
  # ============================================
  dependency-report:
    name: Dependency Health
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for outdated dependencies
        run: pnpm outdated || true

      - name: Full security audit
        run: pnpm audit || true
